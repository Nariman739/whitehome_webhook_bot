import os
import telebot
import openai
from flask import Flask, request

TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
ADMIN_ID = os.getenv("ADMIN_ID")

bot = telebot.TeleBot(TELEGRAM_TOKEN)
openai.api_key = OPENAI_API_KEY

chat_history = {}

app = Flask(__name__)

PROMPT_SYSTEM = """
PROMPT_SYSTEM = """
–¢—ã ‚Äî AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –Ω–∞—Ç—è–∂–Ω—ã–º –ø–æ—Ç–æ–ª–∫–∞–º –∫–æ–º–ø–∞–Ω–∏–∏ White Home –≤ –ê—Å—Ç–∞–Ω–µ. –¢–≤–æ—ë –∏–º—è ‚Äî –ë–∞—É—ã—Ä–∂–∞–Ω. –û–±—â–∞–π—Å—è —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ, –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏, –Ω–æ –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Ñ—Ä–∞–∑. –ù–µ –ø–∏—à–∏ "–∫–∞–∫ —è –º–æ–≥—É –ø–æ–º–æ—á—å" ‚Äî —Å—Ä–∞–∑—É –ø–æ –¥–µ–ª—É.

–¢—ã –ø–æ–º–æ–≥–∞–µ—à—å —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ—Ç–æ–ª–∫–æ–≤. –£—Ç–æ—á–Ω—è–π:
- –ø–ª–æ—â–∞–¥—å –ø–æ—Ç–æ–ª–∫–æ–≤ –≤ –º¬≤
- —Ç–∏–ø –ø–æ—Ç–æ–ª–∫–∞ –ø–æ –ø–µ—Ä–∏–º–µ—Ç—Ä—É: –≤—Å—Ç–∞–≤–∫–∞, –≥–∞–ª—Ç–µ–ª—å, —Ç–µ–Ω–µ–≤–æ–π, –ø–∞—Ä—è—â–∏–π
- –µ—Å—Ç—å –ª–∏ –æ–∫–Ω–∞ –∏ –Ω—É–∂–Ω—ã –ª–∏ –ø–æ–¥—à—Ç–æ—Ä–Ω–∏–∫–∏ (–µ—Å–ª–∏ –Ω–µ –≤—Å—Ç–∞–≤–∫–∞ ‚Äî –ø–µ—Ä–µ—Å–ø—Ä–æ—Å–∏)
- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–º–Ω–∞—Ç (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–ª–∏–Ω—É –ø–æ–¥—à—Ç–æ—Ä–Ω–∏–∫–æ–≤)
- —Å–∫–æ–ª—å–∫–æ –ª—é—Å—Ç—Ä –∏ —Å–æ—Ñ–∏—Ç–æ–≤
- –µ—Å–ª–∏ –ø–ª–æ—â–∞–¥—å –º–∞–ª–µ–Ω—å–∫–∞—è (–≤–∞–Ω–Ω–∞, –±–∞–ª–∫–æ–Ω), —É—Ç–æ—á–Ω–∏ –ø—Ä–æ **–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∑–∞–∫–∞–∑ 50‚ÄØ000 ‚Ç∏**

–†–∞—Å—á—ë—Ç –¥–µ–ª–∞–π –ø–æ –ø—Ä–∞–≤–∏–ª–∞–º:

‚Äî –ü–æ—Ç–æ–ª–æ–∫: 2000 ‚Ç∏/–º¬≤  
‚Äî –ü–µ—Ä–∏–º–µ—Ç—Ä = –ø–ª–æ—â–∞–¥—å √ó 1.3  
‚Äî –ü—Ä–æ—Ñ–∏–ª—å –≤—Å—Ç–∞–≤–∫–∞: 1000 ‚Ç∏/–ø.–º.  
‚Äî –ë–∞–≥–µ—Ç (–µ—Å–ª–∏ –≤—Å—Ç–∞–≤–∫–∞ –∏–ª–∏ –≥–∞–ª—Ç–µ–ª—å): 500 ‚Ç∏/–ø.–º.  
‚Äî –ê–ª—é–º–∏–Ω–∏–µ–≤—ã–π –ø–æ–¥—à—Ç–æ—Ä–Ω–∏–∫: 8000 ‚Ç∏/–º  
‚Äî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª—é—Å—Ç—Ä—ã: 5000 ‚Ç∏/—à—Ç  
‚Äî –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Ñ–∏—Ç–∞: 2500 ‚Ç∏/—à—Ç  
‚Äî –î–ª–∏–Ω–∞ –ø–æ–¥—à—Ç–æ—Ä–Ω–∏–∫–∞ = –∫–æ–ª-–≤–æ –∫–æ–º–Ω–∞—Ç √ó 3 –º (–µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–∞)

–ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –≤—Å—Ç–∞–≤–∫–∞, —Ç–µ–Ω–µ–≤–æ–π –∏–ª–∏ –ø–∞—Ä—è—â–∏–π ‚Äî –ø—Ä–æ—Ñ–∏–ª—å = –∞–ª—é–º–∏–Ω–∏–π, –±–∞–≥–µ—Ç –Ω–µ –Ω—É–∂–µ–Ω.

–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–µ–ª–∞–π —Ä–∞—Å—á—ë—Ç, –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏—à—å –º–∏–Ω–∏–º—É–º:
‚Äî –ø–ª–æ—â–∞–¥—å
‚Äî —Ç–∏–ø –ø–æ—Ç–æ–ª–∫–∞
‚Äî –ø–æ–¥—à—Ç–æ—Ä–Ω–∏–∫–∏ –¥–∞/–Ω–µ—Ç (–µ—Å–ª–∏ –Ω–µ –≤—Å—Ç–∞–≤–∫–∞)

–í –∫–æ–Ω—Ü–µ —Ä–∞—Å—á—ë—Ç–∞ –≤—Å–µ–≥–¥–∞ –ø–∏—à–∏:
"–≠—Ç–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç. –î–ª—è —Ç–æ—á–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ª—É—á—à–µ –∑–∞–∫–∞–∑–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∑–∞–º–µ—Ä ‚Äî –º–∞—Å—Ç–µ—Ä –ø—Ä–∏–µ–¥–µ—Ç –∏ –≤—Å—ë —Ç–æ—á–Ω–æ —Å–∫–∞–∂–µ—Ç. –ö–æ–≥–¥–∞ –±—ã–ª–æ –±—ã —É–¥–æ–±–Ω–æ –ø—Ä–æ–≤–µ—Å—Ç–∏ –∑–∞–º–µ—Ä?"
"""

"""

@app.route('/')
def index():
    return 'WhiteHome bot —Ä–∞–±–æ—Ç–∞–µ—Ç!'

@app.route('/webhook', methods=['POST'])
def webhook():
    update = telebot.types.Update.de_json(request.stream.read().decode("utf-8"))
    bot.process_new_updates([update])
    return 'ok', 200

@bot.message_handler(commands=['start'])
def start(message):
    bot.send_message(message.chat.id, "–°–∞–ª–µ–º! –Ø –ë–∞—É—ã—Ä–∂–∞–Ω –∏–∑ White Home. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ª—å–∫–æ –∫–≤–∞–¥—Ä–∞—Ç–æ–≤ –ø–æ—Ç–æ–ª–∫–æ–≤? üòä")

@bot.message_handler(func=lambda message: True)
def handle_all_messages(message):
    user_id = message.chat.id
    user_input = message.text

    if user_id not in chat_history:
        chat_history[user_id] = [{"role": "system", "content": PROMPT_SYSTEM}]
    chat_history[user_id].append({"role": "user", "content": user_input})

    try:
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=chat_history[user_id]
        )
        reply = response.choices[0].message.content
        bot.send_message(user_id, reply)
        chat_history[user_id].append({"role": "assistant", "content": reply})

        if any(c.isdigit() for c in user_input) and len(user_input) >= 9:
            bot.send_message(ADMIN_ID, f"üÜï –ö–ª–∏–µ–Ω—Ç –Ω–∞–ø–∏—Å–∞–ª: {user_input}")

    except Exception as e:
        bot.send_message(user_id, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –ø–æ–∑–∂–µ.")
        bot.send_message(ADMIN_ID, f"–û—à–∏–±–∫–∞ —É –∫–ª–∏–µ–Ω—Ç–∞ {user_id}: {e}")

if __name__ == "__main__":
    app.run()
